services:
  # -------------------------------------------------------
  # 1. TRAEFIK
  # -------------------------------------------------------
  traefik:
    build: . 
    container_name: traefik-${TRAEFIK_PROFILE} # Good practice: make name unique
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - webnet
    ports:
      # NOTE: If multiple Traefiks run on the same host,
      # they cannot all bind to port 80/443!
      # Either each Traefik has its own IP (macvlan)
      # or you use different ports (e.g., 8081:80).
      # Using standard ports as an example:
      - "80:80"
      - "443:443"
    environment:
      - EXEC_PATH=/usr/local/bin/dns-hook.sh
      - MICETRO_API_URL=${MICETRO_API_URL}
      - MICETRO_TOKEN=${MICETRO_TOKEN}
      - MICETRO_ZONE=${MICETRO_ZONE}
      - TRAEFIK_PROFILE=${TRAEFIK_PROFILE} # Make profile available as ENV
      - EXEC_POLLING_INTERVAL=10
      - EXEC_PROPAGATION_TIMEOUT=120
      - LEGO_DISABLE_CNAME_SUPPORT=false
      - LEGO_EXPERIMENTAL_DNS_RESOLVERS=8.8.8.8:53
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
    command:
      - "--log.level=INFO"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      
      # --- IMPORTANT: CONSTRAINT ---
      # Traefik ignores all containers that do NOT have this label.
      - "--providers.docker.constraints=Label(`traefik.profile`, `${TRAEFIK_PROFILE}`)"
      
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      - "--certificatesresolvers.myresolver.acme.dnschallenge=true"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.provider=exec"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.delaybeforecheck=10"
      - "--certificatesresolvers.myresolver.acme.email=admin@example.de"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.resolvers=8.8.8.8:53,1.1.1.1:53"

      # STAGING (Remove for production):
      - "--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"

  # -------------------------------------------------------
  # 2. APP (Nginx)
  # -------------------------------------------------------
  webapp:
    image: nginx:alpine
    container_name: webapp-${TRAEFIK_PROFILE}
    restart: unless-stopped
    networks:
      - webnet
    labels:
      - "traefik.enable=true"
      
      # --- IMPORTANT: PROFILE ASSIGNMENT ---
      # Without this label, Traefik would ignore this container!
      - "traefik.profile=${TRAEFIK_PROFILE}"
      
      # Router configuration
      - "traefik.http.routers.webapp.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.webapp.entrypoints=websecure"
      - "traefik.http.routers.webapp.tls.certresolver=myresolver"
      - "traefik.http.services.webapp.loadbalancer.server.port=80"

networks:
  webnet:
    driver: bridge
